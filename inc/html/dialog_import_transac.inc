<script>	var mon_xhr;	var progressbar ;	var progressTitle ;	var progressLabel ;	var reader;		$(document).ready(function(){				$('#import_link').click(function(){			$('#file_import').click();		});				$('#file_import').change(function(evt){			server_import_transactions();			$(this).val('');		});				$('#dialog-import-transac').dialog({			autoOpen: false,			dialogClass: "alert",			height: 120,			width: 300,			modal: true,			close: function() {console.log("dialog-import-transac closed");}			});				progressbar = $( "#progressbar" );		progressTitle = $( "#progresstitle" );		progressLabel = $( ".progress-label" );	 		progressbar.progressbar({			value: false,			change: function() {				progressLabel.text( progressbar.progressbar( "value" )  + "%" );				console.log("Progress " + progressbar.progressbar( "value" )  + "%");			},			complete: function(){				$('#abort_link').hide();				console.log("Progress 100%");				$(this).progressbar("value", false);			}		});					});			//SERVER IMPORT	function progressHandlingFunction(e){		if(e.lengthComputable){			percentComplete = Math.round(e.loaded * 100 / e.total);			progressbar.progressbar( "value", percentComplete);		}	}	function uploadCanceled(e){		console.log("Annulation upload !");		$('#dialog-import-transac').dialog('close');		var notif = noty({			layout: 'top',			type: 'alert',			timeout: 10000,			text: 'Opération annulée !'		});	}		function server_import_transactions(){		console.log("server_import_transactions");				$('#abort_link').click(function(){			mon_xhr.abort();		});				progressTitle.text('Envoi du fichier :');				id_compte = $('.actif').data('id');				var formData = new FormData($('form')[0]);				mon_xhr = $.ajax({			url: 'importer.php?idc='+id_compte,  //server script to process data			type: 'POST',			dataType:"json",			xhr: function() {  // custom xhr				var myXhr = $.ajaxSettings.xhr();				if(myXhr.upload){ // check if upload property exists					$('#dialog-import-transac').dialog('open');					$('#abort_link').show();					myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // for handling the progress of the upload					myXhr.upload.addEventListener('abort', uploadCanceled, false);				}				return myXhr;			},			//Ajax events			beforeSend: function( jqXHR,  settings ){return true;},			success: function (data, status){				if(data.status){					console.log("server import status OK !");					progressTitle.text('Traitement du fichier :');					$('#abort_link').hide();					console.log("Import " +data.import_id + " du compte " + data.compte.libelle + " : " + data.nb_transactions + " transactions trouvées, " + data.nb_duplicates + " transactions en doublons");										console.log("Solde avant import = " + $('#solde_cpt').data('solde_cpt'));										progressbar.progressbar( "value", 0);					$.each(data.compte.transactions, function(key, value){												percentComplete = Math.round((key+1) * 100 / data.nb_transactions);						progressbar.progressbar( "value", percentComplete);												prepend_transaction(value);					});					progressbar.progressbar( "value", 100);										console.log("Solde après import = " + $('#solde_cpt').data('solde_cpt'));										var notif = noty({						layout: 'top',						type: 'success',						timeout: 10000,						text: data.nb_transactions + ' transaction(s) ont été importées !'					});										if(data.duplicates != null){						progressTitle.text('Traitement des doublons :');						progressbar.progressbar( "value", 0);												console.log("data.duplicates is not null");						var noty_2 = null;						clear_duplicate_decision_list();						var nb_duplicates = 0;						$.each(data.duplicates, function(key, duplicate){							nb_duplicates = nb_duplicates + 1;														percentComplete = Math.round((nb_duplicates) * 100 / data.nb_duplicates);							progressbar.progressbar( "value", percentComplete);																				call_for_duplicate_decision(duplicate);														//mise au 1er plan de la fenetre de progression							$('#dialog-import-transac').dialog('moveToTop');							if(noty_2 == null){								noty_2 = noty({									layout: 'top',									type: 'warning',									timeout: 10000,									text: nb_duplicates + ' transaction(s) existent déjà, impossible de les dupliquer !'								});							}else{								noty_2.setText(nb_duplicates + ' transaction(s) existent déjà, impossible de les dupliquer !');							}						});						progressbar.progressbar( "value", 100);						show_duplicate_decision();					}										//reset bindings					set_edit_transac_bindings();										//mise à jour des soldes par transaction					reset_solde_transactions();										$('#lien_undo_import').data('import_id', data.import_id);					$('#lien_undo_import').show();					$('#import_link').hide();										$('#lien_undo_import').unbind('click');					$('#lien_undo_import').click(function(){						undo_import($('#lien_undo_import').data('import_id'));					});									}else{					alert(data.error);				}						$('#dialog-import-transac').dialog('close');			},			error: function (data, status, e){				//alert(e);			},			// Form data			data: formData,			//Options to tell JQuery not to process data or worry about content-type			cache: false,			contentType: false,			processData: false		});		return false;	}		function undo_import(import_id){				if(import_id != ''){					console.log("Annulation de l'import " + import_id);						$.getJSON('./importer.php?undoid=' + import_id, function(data){								if(data.status){					id_compte = $('.actif').data('id');					get_compte(id_compte);										$('#lien_undo_import').data('import_id', '');					$('#lien_undo_import').hide();					$('#import_link').show();										var notif = noty({						layout: 'top',						type: 'success',						timeout: 10000,						text: 'L\'import a bien été annulé, ' +data.nb_transactions+ ' transactions supprimée(s) !'					});									}else{										var notif = noty({						layout: 'top',						type: 'error',						timeout: 3000,						text: data.error					});									}											});		}else{			console.log("Appel undo_import sans ID");		}	}</script><div id="dialog-import-transac" class="dialog" title="Import de transactions">	<style>	  .progress-label {		float: left;		margin-left: 50%;		margin-top: 5px;		font-weight: bold;		text-shadow: 1px 1px 0 #fff;	  }	  #progressbar .ui-progressbar-value {		background-color: #ccc;	  }	</style>	<div id="progresstitle">&nbsp;</div>	<div id="progressbar"><div class="progress-label"></div></div>	<div>		<span id="abort_link" class="lien">Annuler</span>	</div></div>